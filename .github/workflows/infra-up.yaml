name: Infrastructure Up

on:
    workflow_dispatch:
    workflow_call:

env:
    AWS_REGION: ap-southeast-1
    TF_VERSION: 1.13.3

jobs:
    setup:
        name: ğŸ”§ Setup & Validation
        runs-on: ubuntu-latest

        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ğŸ” Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: ğŸ› ï¸ Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: ${{ env.TF_VERSION }}

            - name: âœ… Validation Complete
              run: echo "âœ… Setup complete - ready to provision infrastructure"

    terraform-infra:
        name: ğŸ—ï¸ Provision EKS Infrastructure
        needs: setup
        runs-on: ubuntu-latest

        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ğŸ” Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: ğŸ› ï¸ Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: ${{ env.TF_VERSION }}

            - name: ğŸ”„ Terraform Init
              working-directory: ./infra
              run: terraform init

            - name: ğŸ“‹ Terraform Plan
              working-directory: ./infra
              run: |
                  echo "ğŸ“Š Planning infrastructure changes..."
                  terraform plan \
                    -target=module.eks \
                    -target=aws_nat_gateway.main \
                    -out=tfplan

            - name: ğŸš€ Terraform Apply
              working-directory: ./infra
              run: |
                  echo "ğŸ—ï¸ Provisioning EKS cluster and NAT gateways..."
                  terraform apply -auto-approve tfplan

            - name: âœ… Infrastructure Provisioned
              run: echo "âœ… EKS cluster and networking infrastructure created"

    configure-eks:
        name: âš™ï¸ Configure EKS Cluster
        needs: terraform-infra
        runs-on: ubuntu-latest

        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ğŸ” Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: ğŸ”— Configure kubectl
              run: |
                  echo "ğŸ”— Connecting to EKS cluster..."
                  aws eks update-kubeconfig \
                    --name exploresg-prod-cluster \
                    --region ${{ env.AWS_REGION }}

            - name: ğŸ” Verify EKS Cluster
              run: |
                  echo "ğŸ” Verifying cluster status..."
                  kubectl get nodes
                  kubectl get namespaces

            - name: âœ… EKS Ready
              run: echo "âœ… EKS cluster is operational"

    install-controllers:
        name: ğŸ›ï¸ Install Load Balancer Controller
        needs: configure-eks
        runs-on: ubuntu-latest

        steps:
            - name: ğŸ” Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: ğŸ”— Configure kubectl
              run: |
                  aws eks update-kubeconfig \
                    --name exploresg-prod-cluster \
                    --region ${{ env.AWS_REGION }}

            - name: ğŸ“¦ Install AWS Load Balancer Controller
              run: |
                  echo "ğŸ“¦ Adding Helm repository..."
                  helm repo add eks https://aws.github.io/eks-charts
                  helm repo update

                  echo "ğŸ›ï¸ Installing AWS Load Balancer Controller..."
                  helm upgrade --install aws-load-balancer-controller eks/aws-load-balancer-controller \
                    -n kube-system \
                    --set clusterName=exploresg-prod-cluster \
                    --set serviceAccount.create=true \
                    --set serviceAccount.name=aws-load-balancer-controller

            - name: â³ Wait for Controller Ready
              run: |
                  echo "â³ Waiting for controller to be ready..."
                  kubectl wait --for=condition=ready pod \
                    -l app.kubernetes.io/name=aws-load-balancer-controller \
                    -n kube-system \
                    --timeout=300s

            - name: âœ… Controller Installed
              run: echo "âœ… AWS Load Balancer Controller is ready"

    summary:
        name: ğŸ“Š Deployment Summary
        needs: [setup, terraform-infra, configure-eks, install-controllers]
        runs-on: ubuntu-latest

        steps:
            - name: ğŸ‰ Infrastructure Ready
              run: |
                  echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                  echo "â•‘   âœ… INFRASTRUCTURE READY!               â•‘"
                  echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                  echo ""
                  echo "âœ… EKS Cluster provisioned"
                  echo "âœ… Worker nodes running"
                  echo "âœ… NAT Gateways configured"
                  echo "âœ… AWS Load Balancer Controller installed"
                  echo ""
                  echo "ğŸš€ Ready to deploy applications!"
                  echo "ğŸ’¡ Next: Run 'Application Up' workflow"
